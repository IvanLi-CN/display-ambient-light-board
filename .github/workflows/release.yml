name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0
    
    - name: Generate semantic version
      id: version
      uses: paulhatch/semantic-version@v5.4.0
      with:
        tag_prefix: "v"
        major_pattern: "BREAKING CHANGE:"
        minor_pattern: "feat:"
        version_format: "${major}.${minor}.${patch}"
        bump_each_commit: false
        search_commit_body: true
        user_format_type: "csv"
        enable_prerelease_mode: ${{ github.event.inputs.prerelease }}
        debug: false
    
    - name: Override version type if specified
      id: final_version
      run: |
        if [ "${{ github.event.inputs.version_type }}" = "major" ]; then
          VERSION="${{ steps.version.outputs.major_version }}"
        elif [ "${{ github.event.inputs.version_type }}" = "minor" ]; then
          VERSION="${{ steps.version.outputs.minor_version }}"
        else
          VERSION="${{ steps.version.outputs.version }}"
        fi
        
        if [ "${{ github.event.inputs.prerelease }}" = "true" ]; then
          VERSION="${VERSION}-rc.$(date +'%Y%m%d%H%M%S')"
        fi
        
        echo "version=v$VERSION" >> $GITHUB_OUTPUT
        echo "Final version: v$VERSION"
    
    - name: Setup ESP-IDF
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.4.2
        target: esp32c3
    
    - name: Build project
      run: |
        . $IDF_PATH/export.sh
        idf.py build
    
    - name: Generate changelog
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªå‘å¸ƒæ ‡ç­¾
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          echo "## æ›´æ–°å†…å®¹" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "é¦–æ¬¡å‘å¸ƒ" >> CHANGELOG.md
        else
          echo "## æ›´æ–°å†…å®¹" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          # ç”Ÿæˆæäº¤æ—¥å¿—
          git log --pretty=format:"- %s (%h)" $LAST_TAG..HEAD >> CHANGELOG.md
          
          if [ ! -s CHANGELOG.md ] || [ "$(wc -l < CHANGELOG.md)" -le 2 ]; then
            echo "- ä»£ç ä¼˜åŒ–å’Œé”™è¯¯ä¿®å¤" >> CHANGELOG.md
          fi
        fi
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.final_version.outputs.version }}
        name: "Release ${{ steps.final_version.outputs.version }}"
        body: |
          ğŸ‰ **æ­£å¼ç‰ˆæœ¬å‘å¸ƒ**
          
          ${{ steps.changelog.outputs.changelog }}
          
          ## æ„å»ºä¿¡æ¯
          - **æ„å»ºæ—¶é—´:** $(date +'%Y-%m-%d %H:%M:%S UTC')
          - **æäº¤å“ˆå¸Œ:** ${{ github.sha }}
          - **ESP-IDF ç‰ˆæœ¬:** v5.4.2
          - **ç›®æ ‡èŠ¯ç‰‡:** ESP32-C3
          
          ## æ–‡ä»¶è¯´æ˜
          - `display-ambient-light-board.bin` - ä¸»å›ºä»¶æ–‡ä»¶ï¼ˆæ¨¡æ¿ç‰ˆæœ¬ï¼Œéœ€è¦é…ç½®åçƒ§å½•ï¼‰
          - `display-ambient-light-board.elf` - è°ƒè¯•ç¬¦å·æ–‡ä»¶
          - `display-ambient-light-board.map` - å†…å­˜æ˜ å°„æ–‡ä»¶
          - `firmware-config-tool.html` - å›ºä»¶é…ç½®å·¥å…·

          ## é…ç½®å’Œçƒ§å½•æ–¹æ³•

          ### 1. é…ç½®å›ºä»¶
          1. ä¸‹è½½ `firmware-config-tool.html` é…ç½®å·¥å…·
          2. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€é…ç½®å·¥å…·
          3. ä¸Šä¼  `display-ambient-light-board.bin` å›ºä»¶æ–‡ä»¶
          4. å¡«å†™ä½ çš„ WiFi SSID å’Œå¯†ç ç­‰é…ç½®
          5. ç‚¹å‡»"ä¸‹è½½é…ç½®åçš„å›ºä»¶"è·å¾—ä¸ªæ€§åŒ–å›ºä»¶

          ### 2. çƒ§å½•å›ºä»¶
          ```bash
          esptool.py --chip esp32c3 --port /dev/ttyUSB0 --baud 460800 write_flash 0x0 display-ambient-light-board-configured.bin
          ```
        files: |
          build/display-ambient-light-board.bin
          build/display-ambient-light-board.elf
          build/display-ambient-light-board.map
          tools/firmware-config-tool.html
        prerelease: ${{ github.event.inputs.prerelease }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
